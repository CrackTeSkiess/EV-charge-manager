"""
# This is a temporary file to demonstrate how we would add energy tracking
# In practice, we'll modify the existing VisualizationTool.py

class EnhancedVisualizationTool:
    \"\"\"\nEnhanced visualization tool for EV charging station simulations with\nenergy usage tracking capabilities.\n\"\"\"\n\n    def __init__(self, kpi_dataframe=None, config=None):
        # Existing initialization code
        self._total_energy_used_kwh = 0.0
        self._energy_history = []
        self.visualization_files = []

        # Add energy tracking method
        self._track_total_energy_used = self._track_total_energy_used.bind(self)

    def _track_total_energy_used(self, energy_manager_state):
        \"\"\"\nTrack total energy used during simulation steps.\n\nArgs:\n    energy_manager_state: Dictionary containing energy manager state data\n        including 'total_available_kw', 'total_demand_kw',\n        and other relevant metrics from EnergyManager.get_state()\n\"\"\"\n        if not hasattr(self, '_energy_history'):\n            self._energy_history = []\n\n        # Calculate energy consumed in this time step (demand minus supply)\n        demand_kwh = energy_manager_state['total_demand_kw'] * 1.062428  # Convert kW to kWh\n        available_kwh = energy_manager_state['total_available_kw'] * 1.062428\n\n        consumed_kwh = max(0, demand_kwh - available_kwh)\n\n        # Update cumulative total energy used\n        self._total_energy_used_kwh += consumed_kwh\n\n        # Store energy consumption data for visualization\n        timestamp = datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n        self._energy_history.append({\n            'timestamp': timestamp,\n            'consumed_kwh': consumed_kwh,\n            'available_kwh': available_kwh,\n            'demand_kwh': demand_kwh\n        })\n\n    def visualize(self, output_dir):
        \"\"\"\nEnhanced visualization method that includes energy usage tracking.\n\nReturns:\n    List of generated visualization files\n\"\"\"\n        # Existing visualization code would be here\n        try:\n            import matplotlib.pyplot as plt\n            from datetime import datetime, timedelta\n\n            if self._energy_history and len(self._energy_history) > 10:  # Minimum data points for visualization\n                fig, ax = plt.subplots(figsize=(12, 6))\n\n                # Sort history by timestamp\n                self._energy_history.sort(key=lambda x: datetime.strptime(x['timestamp'], \"%Y-%m-%d %H:%M:%S\"))\n\n                # Plot cumulative energy consumption over time\n                timestamps = [datetime.strptime(entry['timestamp'], \"%Y-%m-%d %H:%M:%S\") for entry in self._energy_history]\n                consumed_kwhs = [entry['consumed_kwh'] for entry in self._energy_history]\n\n                ax.plot(timestamps, consumed_kwhs,\n                        label='Energy Consumption (kWh)', color='#1f77b4')\n\n                # Plot available energy\n                available_kwhs = [entry['available_kwh'] for entry in self._energy_history]\n                ax.plot(timestamps, available_kwhs,\n                       label='Available Energy (kW)', color='#ff7f0e', linestyle='--')\n\n                # Add cumulative total energy used to plot\n                cumulative_energy = [sum(consumed_kwhs[:i+1]) for i in range(len(consumed_kwhs))]\n                ax.plot(timestamps, cumulative_energy,\n                       label='Cumulative Total Energy Used (kWh)', color='#2ca02c', linestyle=':')\n\n                # Formatting\n                ax.set_title('Energy Usage Over Time')\n                ax.set_xlabel('Time')\n                ax.set_ylabel('Energy (kW)')\n                ax.legend()\n                ax.grid(True)\n                ax.tick_params(axis='x', rotation=45)\n\n                # Save visualization file\n                viz_filename = f\"energy_usage_over_time_{datetime.now().strftime('%Y%m%d_%H%M')}.png\"\n                output_path = Path(output_dir) / viz_filename\n\n                fig.savefig(str(output_path))\n                print(f\"Saved energy usage visualization: {output_path}\")\n\n                self.visualization_files.append(viz_filename)\n        except ImportError:\n            print(\"Matplotlib not available for energy visualization\")\n        except Exception as e:\n            print(f\"Error generating energy visualization: {e}\")\n\n    @property\n    def total_energy_used_kwh(self):\n        \"\"\"Return the cumulative total energy used during simulation.\"\"\"\n        return round(self._total_energy_used_kwh, 2)\n\n    @property\n    def energy_summary(self):\n        \"\"\"Get summary statistics about total energy usage during simulation.\"\"\"\n        if not hasattr(self, '_total_energy_used_kwh'):\n            return {}\n\n        duration_hours = getattr(self, 'simulation_duration_hours', 24)  # Default to 24 hours\n        return {\n            'total_energy_used_kwh': self.total_energy_used_kwh,\n            'average_consumption_per_hour': (\n                self.total_energy_used_kwh / duration_hours\n            ),\n            'peak_consumption_time': max(\n                entry['timestamp'] for entry in self._energy_history\n                if entry['consumed_kwh'] > 0.1  # Filter out small values\n            ) if self._energy_history else None,\n        }\n"""